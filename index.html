<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Counselling Notes</title>
<style>
/* ===== BODY ===== */
body {
  font-family: Arial, sans-serif;
  margin: 20px;
  background-color: #cce7ff; /* pastel blue */
}

/* ===== FILTERS ===== */
.filters {
  display:flex;
  gap:15px;
  align-items:center;
  flex-wrap:wrap;
}

.filters div {
  display:flex;
  flex-direction:column;
}

/* ===== INPUTS ===== */
select, input, textarea, button {
  margin: 5px 0;
  padding: 5px;
}

/* ===== NOTE BOX ===== */
#note {
  border:1px solid #ccc;
  padding:10px;
  width:70%;
  min-height:150px;
  max-height:500px;
  overflow-y:auto;
  background:#f9f9f9;
}

/* ===== HEADINGS ===== */
h2,h3 {
  color:#333;
  margin-bottom:5px;
}

/* ===== LABEL ===== */
label {
  font-weight:bold;
  margin-top:10px;
}

/* ===== BULLETS & NUMBERING ===== */
ul { margin-left:20px; list-style-type:none; }
ul li::before { content: "- "; }
ol { margin-left:30px; }

/* ===== BUTTONS ===== */
button {
  cursor:pointer;
}
</style>
</head>
<body>

<h2>Counselling Notes</h2>

<!-- Horizontal Filter -->
<div class="filters">
  <div>
    <label>Status:</label>
    <select id="status">
      <option value="">--Pilih Status--</option>
      <option value="New">New</option>
      <option value="Reassess">Reassess</option>
    </select>
  </div>
  <div>
    <label>Patient Type:</label>
    <select id="patientType">
      <option value="">--Pilih Patient Type--</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
      <option value="Kids">Kids</option>
      <option value="Caretaker">Caretaker</option>
    </select>
  </div>
  <div>
    <label>Organ:</label>
    <select id="organ">
      <option value="">--Pilih Organ--</option>
      <option value="Eyes">Eyes</option>
      <option value="Nose">Nose</option>
      <option value="Repsi">Repsi</option>
      <option value="GI">GI</option>
    </select>
  </div>
  <div>
    <label>Device / Treatment:</label>
    <select id="device">
      <option value="">--Pilih Device--</option>
    </select>
  </div>
</div>

<br>

<!-- Add Note Box -->
<textarea id="newNote" placeholder="Masukkan nota baru di sini..." rows="6" cols="80"></textarea><br>
<button id="addNote">Add Note</button>
<button id="addAllPatient">Add to All Patient Types</button>
<button id="exportJSON">Export JSON</button>

<br><br>

<!-- Display Notes -->
<div id="note">Nota akan muncul di sini</div>

<script>
// ===== Load Notes dari GitHub =====
let githubLink = "https://raw.githubusercontent.com/nurnabilahbello/counselling-notes/main/notes.json";
let notes = {};

// Fetch JSON dari GitHub
fetch(githubLink)
.then(res => res.json())
.then(data => { notes = data; console.log("Notes loaded"); })
.catch(err => { console.log("Error loading notes:", err); });

// ===== DOM =====
const statusSelect = document.getElementById("status");
const patientSelect = document.getElementById("patientType");
const organSelect = document.getElementById("organ");
const deviceSelect = document.getElementById("device");
const noteDiv = document.getElementById("note");
const newNoteInput = document.getElementById("newNote");
const addNoteBtn = document.getElementById("addNote");
const addAllBtn = document.getElementById("addAllPatient");
const exportBtn = document.getElementById("exportJSON");

// ===== Update Device Dropdown =====
function updateDevices() {
    const status = statusSelect.value;
    const patient = patientSelect.value;
    const organ = organSelect.value;
    deviceSelect.innerHTML = '<option value="">--Pilih Device--</option>';
    noteDiv.innerHTML = 'Nota akan muncul di sini';

    if(status && patient && organ){
        const deviceList = notes[status]?.[patient]?.[organ];
        if(deviceList){
            Object.keys(deviceList).forEach(dev => {
                const opt = document.createElement("option");
                opt.value = dev;
                opt.textContent = dev;
                deviceSelect.appendChild(opt);
            });
        }
    }
}

// ===== Show Note =====
deviceSelect.addEventListener("change", function(){
    const status = statusSelect.value;
    const patient = patientSelect.value;
    const organ = organSelect.value;
    const device = this.value;
    if(status && organ && device){
        const noteText = patient ? notes[status]?.[patient]?.[organ]?.[device] : "";
        let displayText = noteText || "Nota tidak ditemui.";
        // Replace line breaks & substep numbering for display
        displayText = displayText.replace(/\n\d+\./g, m => `<br>${m}`).replace(/\n-/g, m => `<br>${m}`);
        noteDiv.innerHTML = displayText;
    }
});

// ===== Event Listeners for Filters =====
statusSelect.addEventListener("change", updateDevices);
patientSelect.addEventListener("change", updateDevices);
organSelect.addEventListener("change", updateDevices);

// ===== Add Note =====
addNoteBtn.addEventListener("click", function(){
    const status = statusSelect.value;
    const patient = patientSelect.value;
    const organ = organSelect.value;
    const device = deviceSelect.value || "New Device";

    if(!status || !organ){
        alert("Sila pilih Status dan Organ.");
        return;
    }
    if(!newNoteInput.value.trim()){
        alert("Nota kosong tidak boleh disimpan.");
        return;
    }

    const targetPatients = patient ? [patient] : ["Male","Female","Kids","Caretaker"];

    targetPatients.forEach(p=>{
        if(!notes[status][p]) notes[status][p] = {};
        if(!notes[status][p][organ]) notes[status][p][organ] = {};
        notes[status][p][organ][device] = newNoteInput.value;
    });

    alert("Nota berjaya ditambah!");
    newNoteInput.value = "";
    updateDevices();
});

// ===== Add Note to All Patient Types =====
addAllBtn.addEventListener("click", function(){
    const status = statusSelect.value;
    const organ = organSelect.value;
    const device = deviceSelect.value || "New Device";

    if(!status || !organ){
        alert("Sila pilih Status dan Organ.");
        return;
    }
    if(!newNoteInput.value.trim()){
        alert("Nota kosong tidak boleh disimpan.");
        return;
    }

    const allPatients = ["Male","Female","Kids","Caretaker"];
    allPatients.forEach(p=>{
        if(!notes[status][p]) notes[status][p] = {};
        if(!notes[status][p][organ]) notes[status][p][organ] = {};
        notes[status][p][organ][device] = newNoteInput.value;
    });

    alert("Nota berjaya ditambah untuk semua Patient Type!");
    newNoteInput.value = "";
    updateDevices();
});

// ===== Export JSON =====
exportBtn.addEventListener("click", function(){
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(notes, null, 2));
    const dlAnchor = document.createElement('a');
    dlAnchor.setAttribute("href", dataStr);
    dlAnchor.setAttribute("download","notes.json");
    dlAnchor.click();
});

// ===== Initial Load =====
updateDevices();
</script>
</body>
</html>
