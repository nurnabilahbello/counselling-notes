<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Counselling Notes</title>
<style>
body { font-family: Arial, sans-serif; margin:20px; background:#cce7ff; }
.filters { display:flex; gap:15px; align-items:center; flex-wrap:wrap; }
.filters div { display:flex; flex-direction:column; }
select, input, textarea, button { margin:5px 0; padding:5px; }
#note { border:1px solid #ccc; padding:10px; width:70%; min-height:150px; max-height:500px; overflow:auto; background:#f9f9f9; margin-top:5px; white-space: pre-wrap; font-family:monospace; }
#addNoteSlot { border:1px solid #aaa; padding:10px; width:70%; background:#e6f2ff; margin-top:20px; }
h2,h3,h4 { color:#333; margin-bottom:5px; }
label { font-weight:bold; margin-top:10px; }
button { cursor:pointer; }
#searchBox { padding:5px; margin-top:10px; width:300px; }
</style>
</head>
<body>

<h2>Counselling Notes</h2>

<div class="filters">
  <div>
    <label>Status:</label>
    <select id="status">
      <option value="">--Pilih Status--</option>
      <option value="New">New</option>
      <option value="Reassess">Reassess</option>
    </select>
  </div>
  <div>
    <label>Patient Type:</label>
    <select id="patientType">
      <option value="">--Pilih Patient Type--</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
      <option value="Kids">Kids</option>
      <option value="Caretaker">Caretaker</option>
    </select>
  </div>
  <div>
    <label>Organ:</label>
    <select id="organ">
      <option value="">--Pilih Organ--</option>
    </select>
  </div>
  <div>
    <label>Device / Treatment:</label>
    <select id="device">
      <option value="">--Pilih Device--</option>
    </select>
  </div>
</div>

<input type="text" id="searchBox" placeholder="Cari perkataan dalam nota">

<h3>Nota</h3>
<div id="note">Paparan nota akan muncul di sini</div>

<div id="addNoteSlot">
  <div class="filters">
    <div>
      <label>Status:</label>
      <select id="newStatus">
        <option value="">--Pilih Status--</option>
        <option value="New">New</option>
        <option value="Reassess">Reassess</option>
      </select>
    </div>
    <div>
      <label>Patient Type:</label>
      <select id="newPatient">
        <option value="">--Pilih Patient Type--</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Kids">Kids</option>
        <option value="Caretaker">Caretaker</option>
      </select>
    </div>
    <div>
      <label>Organ:</label>
      <input type="text" id="newOrgan">
    </div>
    <div>
      <label>Device / Treatment:</label>
      <input type="text" id="newDevice">
    </div>
  </div>

  <h3>Nota</h3>
  <textarea id="newNote" rows="6" cols="80" placeholder="Masukkan nota di sini..."></textarea><br>
  <button id="addNote">Add Note</button>
  <button id="addAllPatient">Add to All Patient Types</button>
  <button id="exportJSON">Export JSON</button>
</div>

<script>
// ===== Initial Notes =====
let notes = {};

// ===== Fetch JSON dari GitHub =====
fetch('https://raw.githubusercontent.com/nurnabilahbello/counselling-notes/main/notes.json')
  .then(response => response.json())
  .then(data => {
    notes = data;
    populateOrgans();
    updateDevices();
    displayNote();
  })
  .catch(err => {
    console.error("Gagal fetch JSON:", err);
    noteDiv.textContent = "Gagal load data JSON dari GitHub.";
  });

// ===== DOM =====
const statusSelect = document.getElementById("status");
const patientSelect = document.getElementById("patientType");
const organSelect = document.getElementById("organ");
const deviceSelect = document.getElementById("device");
const noteDiv = document.getElementById("note");
const searchBox = document.getElementById("searchBox");

const newStatus = document.getElementById("newStatus");
const newPatient = document.getElementById("newPatient");
const newOrganInput = document.getElementById("newOrgan");
const newDeviceInput = document.getElementById("newDevice");
const newNoteInput = document.getElementById("newNote");
const addNoteBtn = document.getElementById("addNote");
const addAllBtn = document.getElementById("addAllPatient");
const exportBtn = document.getElementById("exportJSON");

// ===== Populate Organ Dropdown dynamically =====
function populateOrgans(){
  let organs = new Set();
  Object.values(notes).forEach(patients=>{
    Object.values(patients).forEach(orgs=>{
      Object.keys(orgs).forEach(o=>{
        organs.add(o);
      });
    });
  });
  organSelect.innerHTML = '<option value="">--Pilih Organ--</option>';
  organs.forEach(o=>{
    const opt = document.createElement("option");
    opt.value = o;
    opt.textContent = o;
    organSelect.appendChild(opt);
  });
}

// ===== Update Device Dropdown =====
function updateDevices(){
  const status = statusSelect.value;
  const patient = patientSelect.value;
  const organ = organSelect.value;
  deviceSelect.innerHTML = '<option value="">--Pilih Device--</option>';
  if(!organ) return;

  let devices = new Set();
  if(status && patient){
    const list = notes[status]?.[patient]?.[organ];
    if(list) Object.keys(list).forEach(d=>devices.add(d));
  } else {
    Object.values(notes).forEach(patients=>{
      Object.values(patients).forEach(orgs=>{
        if(orgs[organ]) Object.keys(orgs[organ]).forEach(d=>devices.add(d));
      });
    });
  }

  devices.forEach(d=>{
    const opt = document.createElement("option");
    opt.value = d;
    opt.textContent = d;
    deviceSelect.appendChild(opt);
  });
}

// ===== Display Notes with new rule =====
function displayNote(){
  const status = statusSelect.value;
  const patient = patientSelect.value;
  const organ = organSelect.value;
  const device = deviceSelect.value;
  const keyword = searchBox.value.trim().toLowerCase();
  noteDiv.innerHTML = "";

  let content = "";

  Object.keys(notes).forEach(s=>{
    if(status && s!==status) return;
    Object.keys(notes[s]).forEach(p=>{
      if(patient && p!==patient) return;
      Object.keys(notes[s][p]).forEach(o=>{
        if(organ && o!==organ) return;
        Object.keys(notes[s][p][o]).forEach(d=>{
          const noteText = notes[s][p][o][d];
          // Hanya display jika device dipilih ATAU match search keyword
          if((device && d===device) || (keyword && noteText.toLowerCase().includes(keyword))){
            content += `Status: ${s}\nPatient: ${p}\nOrgan: ${o}\nDevice: ${d}\n${noteText}\n\n`;
          }
        });
      });
    });
  });

  noteDiv.textContent = content || "Paparan nota akan muncul apabila Device dipilih atau keyword match.";
}

// ===== Add Note =====
function addNoteToPatients(all=false){
  const status = newStatus.value.trim();
  const organ = newOrganInput.value.trim();
  const device = newDeviceInput.value.trim();
  const noteText = newNoteInput.value.trim();

  if(!status || !organ || !device || !noteText){
    alert("Sila pilih Status, dan masukkan Organ, Device/Treatment dan Nota.");
    return;
  }

  if(!notes[status]) notes[status] = {};

  let targetPatients;
  if(all){
    targetPatients = ["Male","Female","Kids","Caretaker"];
  } else {
    if(!newPatient.value){
      alert("Sila pilih Patient Type untuk nota ini.");
      return;
    }
    targetPatients = [newPatient.value];
  }

  targetPatients.forEach(p=>{
    if(!notes[status][p]) notes[status][p] = {};
    if(!notes[status][p][organ]) notes[status][p][organ] = {};
    const oldNote = notes[status][p][organ][device] || "";
    notes[status][p][organ][device] = oldNote ? oldNote + "\n" + noteText : noteText;
  });

  newNoteInput.value = "";
  newOrganInput.value = "";
  newDeviceInput.value = "";
  newPatient.value = "";
  newStatus.value = "";

  populateOrgans();
  updateDevices();
  displayNote();
}

// ===== Event Listeners =====
statusSelect.addEventListener("change", ()=>{ updateDevices(); displayNote(); });
patientSelect.addEventListener("change", ()=>{ updateDevices(); displayNote(); });
organSelect.addEventListener("change", ()=>{ updateDevices(); displayNote(); });
deviceSelect.addEventListener("change", displayNote);
searchBox.addEventListener("input", displayNote);

addNoteBtn.addEventListener("click", ()=>{ addNoteToPatients(false); });
addAllBtn.addEventListener("click", ()=>{ addNoteToPatients(true); });

exportBtn.addEventListener("click", ()=>{
  const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(notes,null,2));
  const dlAnchor = document.createElement('a');
  dlAnchor.setAttribute("href", dataStr);
  dlAnchor.setAttribute("download","notes.json");
  dlAnchor.click();
});

// ===== Initial Load =====
populateOrgans();
updateDevices();
displayNote();
</script>
</body>
</html>




